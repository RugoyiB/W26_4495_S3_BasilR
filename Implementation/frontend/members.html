<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Members</title>
  <script src="authGuard.js"></script>
  <link rel="stylesheet" href="css/attReport.css">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <h2>Church Admin</h2>
    <ul>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="members.html">Members-Report</a></li>
    </ul>
  </nav>

  <div class="table-container">
    <h2>Church Members</h2>
    <div class="filters">
      <button onclick="exportCSV()">Export CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Gender</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Address</th>
          <th>Join Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="membersTable">
        <!-- Rows inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api/members";
    const token = localStorage.getItem("token");
    let membersData = []; // GLOBAL storage for CSV

    // Load members
    async function loadMembers() {
      const token = localStorage.getItem("token");
      const response = await fetch(API_URL, {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });
      const members = await response.json();
      membersData = members; //store for CSV

      const table = document.getElementById("membersTable");
      table.innerHTML = "";

      members.forEach(member => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${member.firstName}</td>
          <td>${member.lastName}</td>
          <td>${member.gender || ""}</td>
          <td>${member.phone || ""}</td>
          <td>${member.email || ""}</td>
          <td>${member.address || ""}</td>
          <td>${member.joinDate ? member.joinDate.split("T")[0] : ""}</td>
          <td>${member.status}</td>
          <td class="actions">
            <i class="fa-solid fa-pen" onclick="editMember('${member._id}')"></i>
            <i class="fa-solid fa-trash" onclick="deleteMember('${member._id}')"></i>
          </td>
        `;

        table.appendChild(row);
      });
    }

    // Edit member (placeholder)
    function editMember(id) {
      alert("Edit member: " + membersData.find(m => m._id === id)?.firstName
        + " " + membersData.find(m => m._id === id)?.lastName);
      window.location.href = `edit-member.html?id=${id}`;
    }

    // Delete member
    async function deleteMember(id) {
      if (!confirm("Are you sure you want to delete this member?")) return;

      const token = localStorage.getItem("token");
      const response = await fetch(`${API_URL}/${id}`, {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const error = await response.text();
        console.error("Delete Failed:", error);
        alert("Failed to Delete Member");
        return;
      }

      alert("Member Deleted Successfully");
      loadMembers();
    }

    function exportCSV() {
      if (membersData.length === 0) {
        alert("No data to export");
        return;
      }

      let csv = "First Name,Last Name,Gender,Phone,Email,Address,Join Date,Status\n";
      membersData.forEach(m => {
        csv += `"${m.firstName}","${m.lastName}","${m.gender || ""}","${m.phone || ""}","${m.email ||
          ""}","${m.address || ""}","${m.joinDate ? m.joinDate.split("T")[0] : ""}","${m.status}"\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "members_report.csv";
      a.click();
    }
    loadMembers();
  </script>

</body>

</html>